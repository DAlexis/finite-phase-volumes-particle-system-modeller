#!/usr/bin/python2.7
import code_utils
import name_generator
import model_defines_h_generator
import fraction_header_generator
import fraction_cpp_generator
import fractions_pool_h_generator
import fractions_pool_cpp_generator
import space_cpp_generator
import model_cpp_generator
import model_output_h_generator
import model_output_cpp_generator
import main_cpp_generator
import Makefile_generator

import yaml
from  optparse import OptionParser
import os
import shutil
import time

# Parsing command line

cmdLineParser = OptionParser()
cmdLineParser.add_option("-d", "--directory", dest="derectory", default="../test/",
                  help="Directory whewre to put generated program", metavar="DIRECTORY")
cmdLineParser.add_option("-c", "--config", dest="config", default="configs/1d.yml",
                  help="Configuration file", metavar="CONFIG")

(cmdLineOptions, cmdLineArgs) = cmdLineParser.parse_args()
configFileName = cmdLineOptions.config
destinationDir = cmdLineOptions.derectory

# Beginning work
print ""
print "Code generation started"

config = yaml.load(open(configFileName))
indiferentDir = 'indiferent/'

generatedFileHeadComment = """ /*
 * This file is generated by script using """ + configFileName + ', ' + time.strftime("%H:%M:%S %d/%m/%Y") + """
 */
"""
generatedFileHeadCommentForMake = """#
# This file is generated by script using """ + configFileName + ', ' + time.strftime("%H:%M:%S %d/%m/%Y") + """
#
"""

#
# Copying files that should not be modified
#
print ""
print "Copying model-indiferent files"
filesAsIs = [
            'axis.cpp',
            'axis.h',
            'fraction-base.h',
            'fraction-cell-interface.h',
            'fraction-space-interface.h',
            'fractions-pool-base.cpp',
            'fractions-pool-base.h',
            'global-defines.h',
            'grid-template.h',
            'output.cpp',
            'output.h',
            'space.h',
            'model.h'
            ]

for fileName in filesAsIs:
    target = os.path.join(indiferentDir, fileName)
    print "Copying " + target + " to " + destinationDir
    shutil.copy(target, destinationDir)

name_generator.completeConfig(config)

#
# Generating code
#
print ""
print "Generating model-defines.h"
model_defines_h_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating fraction-related headers and sources:"
for fractionId in config['model']['fractions']:
    print "   " + fractionId + " header..."
    fraction_header_generator.generate(destinationDir, config, generatedFileHeadComment, fractionId)
    print "   " + fractionId + " source..."
    fraction_cpp_generator.generate(destinationDir, config, generatedFileHeadComment, fractionId)

print "Generating fractions-pool.h"
fractions_pool_h_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating fractions-pool.cpp"
fractions_pool_cpp_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating space.cpp"
space_cpp_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating model.cpp"
model_cpp_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating model-output.h"
model_output_h_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating model-output.cpp"
model_output_cpp_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating main.cpp"
main_cpp_generator.generate(destinationDir, config, generatedFileHeadComment)

print "Generating Makefile"
Makefile_generator.generate(destinationDir, config, generatedFileHeadCommentForMake)


print ""
print "Code generation done."

